<!DOCTYPE html>
<html>
<head>
  <title>Top Repos by Language</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/babel-standalone@7.0.0-beta.3/babel.js"></script>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div id='app'></div>
  <script>
    window.API = {
      fetchPopularRepos(language = 'all') {
        // language can be: javascript, ruby, python, all
        const encodedURI = encodeURI(`https://api.github.com/search/repositories?q=stars:>1+language:${language}&sort=stars&order=desc&type=Repositories`)

        return fetch(encodedURI)
          .then((data) => data.json())
          .then((repos) => repos.items) //this is what gets returned
          .catch((error) => {
            console.warn(error)
            return null
          });
      }
    }
  </script>

  <script type='text/babel'>

    // create List of clickables for language /queryparam selection
    function RepoChoice(props){
      const choices = ['all', 'javascript', 'ruby','python']
      return (choices.map(choice => (
            <button 
              data-name='repo-choice' 
              id= { choice }
              key= { choice }
              onClick={() => {props.param(choice)}} 
            >
              { choice }
            </button>
          )
      ))
    }

    // Loading component, would be called inside RepoResults
    function Loader(props){
      const { useState } = React;
      const [loading, setLoading] = useState('Loading')
      let dot = "."
      let newText;
      function updateText(){
          newText = loading;
          newText += dot;
          if (newText.length > 10){
              dot = ''
              newText = 'Loading'
          }
          console.log(newText) //this shows things do stop
          setLoading(newText) //this also kicks off a new render
          dot += '.'
          return newText
      }
      const loadCall = setTimeout(updateText, 300)
      
      if (props.isLoading === false){
          clearTimeout(loadCall) //worked w timeout but not interval. end the cycle when Loader is no longer shown.
      }
      return (
          <h3> { loading }</h3>
      )
  }

    // show me the results of the API call
    function RepoResults(props){
      // props.data will give you the API results
      const resultList = props.data.map(result => (
        <li 
          key={result.key}
          className='result-item'
        > 
          {/*just cping this next part*/}
            <ul>
                <li><a href={result.html_url}>{result.name}</a></li>
                <li>@{result.owner.login}</li>
                <li>{result.stargazers_count} stars</li>
            </ul>
        </li>
      ))
      return props.isLoading ? (<Loader isLoading = {props.isLoading} />) : 
        (
          <ul>
            { resultList }
          </ul>
        )
    }
  
    // App component
    function App(){
      // import modules needed from React
      const { useState, useEffect, useCallback } = React;
      // const [query, setQuery] = useState('all');
      const [results,setResults] = useState([]); //empty until useEffect calls whichRepo default 'all' and populates results
      const [isLoading, setIsLoading] = useState(false);
      // get param and data
      const whichRepo = useCallback(repo => {
        // useCallback prevents fresh instance creation again of the same function
          // console.log(`You chose ${repo}!`) this does not work, is undefined/ Runs too soon?
        setIsLoading(true);
        API.fetchPopularRepos(repo)
          .then(repoResults => {
              repoResults.map(repoResult => Object.assign(repoResult, {key: repoResults.indexOf(repoResult)}))
              setResults(repoResults);
              setIsLoading(false);
          })
      })

      // useEffect - get data from the window API
      useEffect(()=> { //takes a function as an arg
        console.log(`useEffects on the move`)
        whichRepo(); //needs to run initial to pop and ever after is triggered by setResults callback
      }, []) //seems fine
      
      // update what's rendered based on the change in queryParam (dependency?)
      return (
        <main>
          <section data-function='choice'>
            <RepoChoice param={whichRepo} />
          </section>
          <section data-function='call-results'>
              <RepoResults 
                data={results}
                isLoading={isLoading} 
              />
          </section>
        </main>
      )
    }

    const root = ReactDOM.createRoot(
      document.querySelector('#app')
    )
    root.render(<App />)
  </script>
</body>
</html>